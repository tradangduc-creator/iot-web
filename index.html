<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Web ‚Üî AWS IoT (MQTT over WebSocket)</title>

    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 40px auto;
        max-width: 700px;
        text-align: center;
      }
      h2 {
        color: #333;
      }
      button {
        background: #007bff;
        border: none;
        color: white;
        padding: 10px 18px;
        margin: 8px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background: #0056b3;
      }
      pre {
        background: #111;
        color: #0f0;
        padding: 12px;
        min-height: 200px;
        border-radius: 10px;
        text-align: left;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h2>ƒêi·ªÅu khi·ªÉn & gi√°m s√°t IoT qua AWS</h2>
    <button id="btnStart">‚ñ∂ G·ª≠i START</button>
    <button id="btnStop">‚èπ G·ª≠i STOP</button>
    <pre id="log">ƒêang kh·ªüi ƒë·ªông...</pre>

    <!-- AWS SDK v2 (ƒë·ªÉ l·∫•y credentials t·ª´ Cognito) -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1481.0.min.js"></script>

    <!-- AWS IoT Device SDK for Browser (t·ª´ unpkg CDN ‚Äì ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh tr√™n GitHub Pages) -->
    <script src="https://unpkg.com/aws-iot-device-sdk/browser/aws-iot-sdk-browser-bundle.min.js"></script>

    <script>
      // ====== TH√îNG TIN C·ª¶A B·∫†N (C·∫¨P NH·∫¨T S·∫¥N) ======
      const REGION = "ap-southeast-1";
      const IDENTITY_POOL_ID =
        "ap-southeast-1:4b3cda65-f97c-4b12-9619-18ace38d8cf7";
      const IOT_HOST =
        "d06271991l2t0ukufb3u9-ats.iot.ap-southeast-1.amazonaws.com";
      const TOPIC_PUB = "web/control"; // Topic g·ª≠i l·ªánh ƒëi·ªÅu khi·ªÉn
      const TOPIC_SUB = "device/+/out"; // Topic nh·∫≠n ph·∫£n h·ªìi
      // ==============================================

      const $log = document.getElementById("log");
      const log = (...a) => {
        $log.textContent += a.join(" ") + "\n";
        $log.scrollTop = $log.scrollHeight;
      };

      // 1Ô∏è‚É£ C·∫•u h√¨nh AWS Cognito
      AWS.config.region = REGION;
      AWS.config.credentials = new AWS.CognitoIdentityCredentials({
        IdentityPoolId: IDENTITY_POOL_ID,
      });

      // 2Ô∏è‚É£ L·∫•y credentials t·∫°m th·ªùi
      AWS.config.credentials.get((err) => {
        if (err) {
          log("‚ùå L·ªói Cognito:", err);
          return;
        }
        log("‚úÖ ƒê√£ c√≥ AWS credentials t·ª´ Cognito.");

        const creds = AWS.config.credentials;
        const clientId = "web-" + Math.floor(Math.random() * 1e8);

        // 3Ô∏è‚É£ K·∫øt n·ªëi AWS IoT Core qua WebSocket
        const device = awsIot.device({
          region: REGION,
          host: IOT_HOST,
          protocol: "wss",
          clientId,
          accessKeyId: creds.accessKeyId,
          secretKey: creds.secretAccessKey,
          sessionToken: creds.sessionToken,
          maximumReconnectTimeMs: 8000,
          debug: false,
        });

        // 4Ô∏è‚É£ C√°c s·ª± ki·ªán MQTT
        device.on("connect", () => {
          log("üîó ƒê√£ k·∫øt n·ªëi t·ªõi AWS IoT Core v·ªõi clientId:", clientId);
          device.subscribe(
            TOPIC_SUB,
            undefined,
            (e) => e && log("‚ö†Ô∏è L·ªói subscribe:", e)
          );
        });

        device.on("message", (topic, payload) => {
          log("üì• Nh·∫≠n t·ª´", topic, ":", payload.toString());
        });

        device.on("error", (e) => log("‚ö†Ô∏è L·ªói MQTT:", e));
        device.on("reconnect", () => log("‚Üª ƒêang reconnect..."));
        device.on("close", () => log("‚ùå MQTT ƒë√≥ng k·∫øt n·ªëi."));

        // 5Ô∏è‚É£ G·ª≠i l·ªánh START v√† STOP
        const sendCommand = (cmd) => {
          const msg = { cmd, ts: Date.now() };
          device.publish(TOPIC_PUB, JSON.stringify(msg));
          log("üì§ ƒê√£ g·ª≠i:", JSON.stringify(msg));
        };

        document.getElementById("btnStart").onclick = () =>
          sendCommand("START");
        document.getElementById("btnStop").onclick = () => sendCommand("STOP");
      });
    </script>
  </body>
</html>
