<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web ‚Üî AWS IoT (MQTT over WebSocket)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 40px auto; max-width: 760px; text-align: center; }
    h2 { color: #222; }
    .buttons { margin-bottom: 12px; }
    button {
      background: #0b5ed7; border: none; color: #fff; padding: 10px 16px; margin: 6px 6px;
      border-radius: 8px; font-size: 15px; cursor: pointer;
    }
    button:hover { background:#0a53be; }
    pre { background:#111; color:#0f0; padding:14px; min-height:220px; border-radius: 10px; text-align:left; }
  </style>
</head>
<body>
  <h2>ƒêi·ªÅu khi·ªÉn & gi√°m s√°t IoT qua AWS</h2>
  <div class="buttons">
    <button id="btnStart">‚ñ∂ G·ª≠i START</button>
    <button id="btnStop">‚èπ G·ª≠i STOP</button>
  </div>
  <pre id="log">ƒêang kh·ªüi ƒë·ªông...</pre>

  <!-- AWS SDK v2 (Cognito) -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1481.0.min.js"></script>

  <!-- ∆ØU TI√äN: T·∫£i SDK c·ª•c b·ªô (file trong th∆∞ m·ª•c /js). N·∫øu thi·∫øu, s·∫Ω t·ª± fallback sang CDN. -->
  <script src="./js/aws-iot-sdk-browser-bundle.min.js"></script>
  <script>
    // N·∫øu file c·ª•c b·ªô kh√¥ng c√≥ ho·∫∑c kh√¥ng ƒë·ªãnh nghƒ©a awsIot, t·ª± ƒë·ªông th·ª≠ load t·ª´ CDN ƒë·ªÉ ch·∫°y tr√™n GitHub Pages.
    (function ensureAwsIotLoaded() {
      if (typeof window.awsIot !== 'undefined') return;
      const cdns = [
        "https://cdn.jsdelivr.net/npm/aws-iot-device-sdk/browser/aws-iot-sdk-browser-bundle.min.js",
        "https://unpkg.com/aws-iot-device-sdk/browser/aws-iot-sdk-browser-bundle.min.js"
      ];
      const tryLoad = (i=0)=>{
        if(i>=cdns.length) { console.error("Kh√¥ng t·∫£i ƒë∆∞·ª£c AWS IoT SDK t·ª´ CDN."); return; }
        const s=document.createElement('script'); s.src=cdns[i]; s.async=true;
        s.onload=()=>console.log("Loaded AWS IoT SDK from", cdns[i]);
        s.onerror=()=>tryLoad(i+1);
        document.head.appendChild(s);
      };
      tryLoad();
    })();
  </script>

  <script>
  // ====== TH√îNG TIN C·ª¶A B·∫†N (ƒê√É C·∫§U H√åNH S·∫¥N) ======
  const REGION = 'ap-southeast-1';
  const IDENTITY_POOL_ID = 'ap-southeast-1:4b3cda65-f97c-4b12-9619-18ace38d8cf7';
  const IOT_HOST = 'd06271991l2t0ukufb3u9-ats.iot.ap-southeast-1.amazonaws.com';
  const TOPIC_PUB = 'web/control';   // Topic g·ª≠i l·ªánh
  const TOPIC_SUB = 'device/+/out';  // Topic nh·∫≠n ph·∫£n h·ªìi
  // ================================================

  const $log = document.getElementById('log');
  const log = (...a)=>{ $log.textContent += a.join(' ') + "\n"; $log.scrollTop = $log.scrollHeight; };

  // Ch·ªù ƒë·∫øn khi SDK awsIot c√≥ m·∫∑t
  function whenAwsIotReady(cb){
    if (typeof window.awsIot !== 'undefined') return cb();
    let retry = 0;
    const id = setInterval(()=>{
      if (typeof window.awsIot !== 'undefined') { clearInterval(id); cb(); }
      else if (++retry>50){ clearInterval(id); log("‚ùå Kh√¥ng th·ªÉ n·∫°p aws-iot SDK. Ki·ªÉm tra file ./js/aws-iot-sdk-browser-bundle.min.js ho·∫∑c CDN."); }
    }, 100);
  }

  whenAwsIotReady(() => {
    // 1) Cognito credentials
    AWS.config.region = REGION;
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({ IdentityPoolId: IDENTITY_POOL_ID });
    AWS.config.credentials.get((err) => {
      if (err) { log('‚ùå L·ªói Cognito:', err); return; }
      log('‚úÖ ƒê√£ c√≥ AWS credentials t·ª´ Cognito.');

      const creds = AWS.config.credentials;
      const clientId = 'web-' + Math.floor(Math.random()*1e8);

      // 2) K·∫øt n·ªëi MQTT qua WebSocket
      const device = awsIot.device({
        region: REGION,
        host: IOT_HOST,
        protocol: 'wss',
        clientId,
        accessKeyId: creds.accessKeyId,
        secretKey: creds.secretAccessKey,
        sessionToken: creds.sessionToken,
        maximumReconnectTimeMs: 8000,
        debug: false
      });

      device.on('connect', () => {
        log('üîó MQTT connected as', clientId);
        device.subscribe(TOPIC_SUB, undefined, (e)=> e && log('‚ö†Ô∏è Sub error:', e));
      });
      device.on('message', (topic, payload)=> log('üì•', topic, payload.toString()));
      device.on('error',   (e)=> log('‚ö†Ô∏è MQTT error:', e));
      device.on('reconnect', ()=> log('‚Üª reconnect...'));
      device.on('close', ()=> log('‚ùå MQTT closed'));

      // 3) G·ª≠i l·ªánh
      function send(cmd){
        const msg = { cmd, ts: Date.now() };
        device.publish(TOPIC_PUB, JSON.stringify(msg));
        log('üì§ Sent:', JSON.stringify(msg));
      }
      document.getElementById('btnStart').onclick = ()=> send('START');
      document.getElementById('btnStop').onclick  = ()=> send('STOP');
    });
  });
  </script>
</body>
</html>
